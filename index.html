<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hajj Passport Registration Form - DEBUG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .logo {
            max-width: 150px;
            max-height: 80px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(255,255,255,0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-container {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .bilingual-label {
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
        }

        .label-german {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
            margin-bottom: 2px;
        }

        .label-arabic {
            font-weight: 500;
            color: #5a6c7d;
            font-size: 0.9em;
            direction: rtl;
            text-align: right;
            font-family: 'Arial', 'Tahoma', sans-serif;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        select {
            cursor: pointer;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #3498db;
        }

        .radio-item label {
            cursor: pointer;
            font-weight: 500;
            color: #2c3e50;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed #3498db;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            min-height: 80px;
            text-align: center;
        }

        .file-upload-label:hover {
            border-color: #2980b9;
            background: #e3f2fd;
        }

        .file-error {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .file-info {
            color: #27ae60;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .preview-container {
            margin-top: 15px;
            display: none;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .section-title-arabic {
            font-size: 1.1em;
            margin-top: 5px;
            color: #5a6c7d;
            direction: rtl;
            font-family: 'Arial', 'Tahoma', sans-serif;
        }

        .conditional-field {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
        }

        .conditional-field.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .submit-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 18px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(52, 152, 219, 0.4);
        }

        .submit-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .required {
            color: #e74c3c;
        }

        .info-text {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .success-message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
            text-align: center;
        }

        .error-message {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .container {
                margin: 10px;
            }

            .form-container {
                padding: 20px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div id="logoContainer">
            <img src="./logo.jpg" alt="Logo" class="logo" id="logoImage" onerror="this.style.display='none'">
        </div>

        <h1>Hajj Anmeldung - DEBUG<br><small style="font-size: 0.6em; opacity: 0.9;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¬</small></h1>
        <p>Debug-Version fÃ¼r Fehleranalyse<br><small style="opacity: 0.8;">Ù†Ø³Ø®Ø© Ø§Ù„ØªØµØ­ÙŠØ­ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</small></p>
    </div>

    <div class="form-container">
        <div class="debug-info" id="debugInfo">
            ğŸ› DEBUG-INFO: JavaScript geladen. Warte auf Benutzeraktion...
        </div>

        <div class="success-message" id="successMessage">
            âœ… <strong>Erfolgreich versendet!</strong>
        </div>

        <div class="error-message" id="errorMessage">
            âŒ <strong>Fehler beim Senden</strong>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Daten werden Ã¼bermittelt...</p>
        </div>

        <form id="hajjForm" method="POST">
            <!-- Personal Information Section -->
            <div class="section-title">
                <div>PersÃ¶nliche Informationen</div>
                <div class="section-title-arabic">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Vorname <span class="required">*</span></div>
                        <div class="label-arabic">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</div>
                    </div>
                    <input type="text" id="vorname" name="vorname" placeholder="Vorname / Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„" required>
                </div>
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Nachname <span class="required">*</span></div>
                        <div class="label-arabic">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</div>
                    </div>
                    <input type="text" id="nachname" name="nachname" placeholder="Nachname / Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">E-Mail Adresse <span class="required">*</span></div>
                        <div class="label-arabic">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div>
                    </div>
                    <input type="email" id="email" name="email" placeholder="email@example.com" required>
                </div>
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Telefonnummer (WhatsApp) <span class="required">*</span></div>
                        <div class="label-arabic">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙˆØ§ØªØ³Ø§Ø¨)</div>
                    </div>
                    <input type="tel" id="telefon" name="telefon" placeholder="+49 123 456789" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Geburtsdatum <span class="required">*</span></div>
                        <div class="label-arabic">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</div>
                    </div>
                    <input type="date" id="geburtsdatum" name="geburtsdatum" required>
                </div>
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">NationalitÃ¤t <span class="required">*</span></div>
                        <div class="label-arabic">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</div>
                    </div>
                    <select id="nationalitaet" name="nationalitaet" required>
                        <option value="">NationalitÃ¤t wÃ¤hlen</option>
                        <option value="deutsch">Deutsch</option>
                        <option value="oesterreichisch">Ã–sterreichisch</option>
                        <option value="tuerkisch">TÃ¼rkisch</option>
                        <option value="syrisch">Syrisch</option>
                        <option value="sonstige">Sonstige</option>
                    </select>
                </div>
            </div>

            <!-- Passport Information Section -->
            <div class="section-title">
                <div>Reisepass Informationen</div>
                <div class="section-title-arabic">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</div>
            </div>

            <div class="form-group">
                <div class="bilingual-label">
                    <div class="label-german">Art des Reisepasses <span class="required">*</span></div>
                    <div class="label-arabic">Ù†ÙˆØ¹ Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</div>
                </div>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="pass_europaeisch" name="passart" value="europaeisch" required>
                        <label for="pass_europaeisch">EuropÃ¤ischer Pass</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="pass_blau" name="passart" value="blau" required>
                        <label for="pass_blau">Blauer Reiseausweis</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="pass_auslaendisch" name="passart" value="auslaendisch" required>
                        <label for="pass_auslaendisch">AuslÃ¤ndischer Pass mit Aufenthaltstitel</label>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Passnummer <span class="required">*</span></div>
                        <div class="label-arabic">Ø±Ù‚Ù… Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</div>
                    </div>
                    <input type="text" id="passnummer" name="passnummer" placeholder="Passnummer" required>
                </div>
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Pass GÃ¼ltigkeit <span class="required">*</span></div>
                        <div class="label-arabic">ØµÙ„Ø§Ø­ÙŠØ© Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</div>
                    </div>
                    <input type="date" id="passgueltigkeit" name="passgueltigkeit" required>
                </div>
            </div>

            <!-- Conditional Aufenthaltstitel Field -->
            <div id="aufenthaltstitelSection" class="conditional-field">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Aufenthaltstitel hochladen <span class="required">*</span></div>
                        <div class="label-arabic">ØªØ­Ù…ÙŠÙ„ ØªØµØ±ÙŠØ­ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</div>
                    </div>
                    <div class="file-upload">
                        <input type="file" id="aufenthaltstitel-image" name="aufenthaltstitel-image" accept="image/*,application/pdf">
                        <label for="aufenthaltstitel-image" class="file-upload-label">
                            <div>
                                <div style="font-size: 2em; margin-bottom: 10px; color: #3498db;">ğŸ“„</div>
                                <div style="color: #2c3e50; font-weight: 500;">Aufenthaltstitel hochladen</div>
                                <small>JPG, PNG, PDF â€¢ Max. 10MB</small>
                            </div>
                        </label>
                    </div>
                    <div class="file-error" id="aufenthaltstitel-error"></div>
                    <div class="file-info" id="aufenthaltstitel-info"></div>
                    <div class="preview-container" id="aufenthaltstitel-preview">
                        <img class="image-preview" id="aufenthaltstitel-img">
                    </div>
                </div>
            </div>

            <!-- Document Upload Section -->
            <div class="section-title">
                <div>Dokumente hochladen</div>
                <div class="section-title-arabic">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Reisepass Kopie <span class="required">*</span></div>
                        <div class="label-arabic">Ù†Ø³Ø®Ø© Ù…Ù† Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</div>
                    </div>
                    <div class="file-upload">
                        <input type="file" id="passport-copy" name="passport-copy" accept="image/*,application/pdf" required>
                        <label for="passport-copy" class="file-upload-label">
                            <div>
                                <div style="font-size: 2em; margin-bottom: 10px; color: #3498db;">ğŸ“‹</div>
                                <div style="color: #2c3e50; font-weight: 500;">Reisepass Kopie</div>
                                <small>JPG, PNG, PDF â€¢ Max. 10MB</small>
                            </div>
                        </label>
                    </div>
                    <div class="file-error" id="passport-copy-error"></div>
                    <div class="file-info" id="passport-copy-info"></div>
                    <div class="preview-container" id="passport-copy-preview">
                        <img class="image-preview" id="passport-copy-img">
                    </div>
                </div>

                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Biometrisches Passbild <span class="required">*</span></div>
                        <div class="label-arabic">ØµÙˆØ±Ø© Ø¬ÙˆØ§Ø² Ø³ÙØ± Ø¨ÙŠÙˆÙ…ØªØ±ÙŠØ©</div>
                    </div>
                    <div class="file-upload">
                        <input type="file" id="passport-photo" name="passport-photo" accept="image/*,application/pdf" required>
                        <label for="passport-photo" class="file-upload-label">
                            <div>
                                <div style="font-size: 2em; margin-bottom: 10px; color: #3498db;">ğŸ“·</div>
                                <div style="color: #2c3e50; font-weight: 500;">Biometrisches Passbild</div>
                                <small>JPG, PNG, PDF â€¢ Max. 10MB</small>
                            </div>
                        </label>
                    </div>
                    <div class="file-error" id="passport-photo-error"></div>
                    <div class="file-info" id="passport-photo-info"></div>
                    <div class="preview-container" id="passport-photo-preview">
                        <img class="image-preview" id="passport-photo-img">
                    </div>
                </div>
            </div>

            <!-- Nusuk Registration Section -->
            <div class="section-title">
                <div>ğŸ“± Nusuk Registration</div>
                <div class="section-title-arabic">ØªØ³Ø¬ÙŠÙ„ Ù†Ø³Ùƒ</div>
            </div>

            <div class="form-group">
                <div class="bilingual-label">
                    <div class="label-german">Haben Sie sich bereits auf Nusuk registriert? <span class="required">*</span></div>
                    <div class="label-arabic">Ù‡Ù„ Ù‚Ù…Øª Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù„Ù‰ Ù†Ø³Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ</div>
                </div>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="nusuk_ja" name="nusuk_registriert" value="ja" required>
                        <label for="nusuk_ja">Ja / Ù†Ø¹Ù…</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="nusuk_nein" name="nusuk_registriert" value="nein" required>
                        <label for="nusuk_nein">Nein / Ù„Ø§</label>
                    </div>
                </div>
            </div>

            <button type="button" class="submit-btn" id="submitButton">
                ğŸ“¤ Hajj-Anmeldung absenden (DEBUG)
            </button>
        </form>
    </div>
</div>

<script>
    // DEBUG LOGGING
    function debugLog(message) {
        console.log('ğŸ› DEBUG:', message);
        const debugInfo = document.getElementById('debugInfo');
        if (debugInfo) {
            debugInfo.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
        }
    }

    debugLog('Script wird geladen...');

    // Document ready handler
    document.addEventListener('DOMContentLoaded', function() {
        debugLog('DOM bereit, Event-Listener werden eingerichtet...');

        try {
            setupEventListeners();
            debugLog('Event-Listener erfolgreich eingerichtet');
        } catch (error) {
            debugLog('FEHLER beim Einrichten der Event-Listener: ' + error.message);
        }
    });

    function setupEventListeners() {
        // Submit button click handler
        const submitButton = document.getElementById('submitButton');
        if (submitButton) {
            submitButton.addEventListener('click', function(e) {
                debugLog('Submit-Button geklickt!');
                e.preventDefault();
                e.stopPropagation();
                handleFormSubmission();
            });
            debugLog('Submit-Button Event-Listener hinzugefÃ¼gt');
        } else {
            debugLog('FEHLER: Submit-Button nicht gefunden!');
        }

        // Form submit handler (backup)
        const form = document.getElementById('hajjForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                debugLog('Form-Submit Event ausgelÃ¶st (wird blockiert)');
                e.preventDefault();
                e.stopPropagation();
                handleFormSubmission();
                return false;
            });
            debugLog('Form Event-Listener hinzugefÃ¼gt');
        } else {
            debugLog('FEHLER: Form nicht gefunden!');
        }

        // Conditional Aufenthaltstitel field
        const passartRadios = document.querySelectorAll('input[name="passart"]');
        passartRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                debugLog('Passart geÃ¤ndert zu: ' + this.value);
                const aufenthaltstitelSection = document.getElementById('aufenthaltstitelSection');
                const aufenthaltstitelInput = document.getElementById('aufenthaltstitel-image');

                if (this.value === 'auslaendisch') {
                    aufenthaltstitelSection.classList.add('show');
                    aufenthaltstitelInput.required = true;
                    debugLog('Aufenthaltstitel-Feld angezeigt und als erforderlich markiert');
                } else {
                    aufenthaltstitelSection.classList.remove('show');
                    aufenthaltstitelInput.required = false;
                    debugLog('Aufenthaltstitel-Feld ausgeblendet');
                }
            });
        });
        debugLog('Passart Event-Listener hinzugefÃ¼gt');

        // File upload handlers
        setupFileUpload('passport-copy');
        setupFileUpload('passport-photo');
        setupFileUpload('aufenthaltstitel-image');
    }

    function setupFileUpload(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    debugLog(`Datei ausgewÃ¤hlt fÃ¼r ${inputId}: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);

                    // Simple validation
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    if (file.size > maxSize) {
                        debugLog(`FEHLER: Datei zu groÃŸ: ${(file.size/1024/1024).toFixed(1)}MB`);
                        alert(`Datei zu groÃŸ: ${(file.size/1024/1024).toFixed(1)}MB (Max: 10MB)`);
                        input.value = '';
                        return;
                    }

                    // Show preview for images
                    if (file.type.startsWith('image/')) {
                        const preview = document.getElementById(inputId + '-preview');
                        const img = document.getElementById(inputId + '-img');
                        if (preview && img) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                img.src = e.target.result;
                                preview.style.display = 'block';
                                debugLog(`Bild-Vorschau fÃ¼r ${inputId} angezeigt`);
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                }
            });
            debugLog(`File-Upload Event-Listener fÃ¼r ${inputId} hinzugefÃ¼gt`);
        }
    }

    // Main form submission handler
    function handleFormSubmission() {
        debugLog('=== FORM SUBMISSION GESTARTET ===');

        const form = document.getElementById('hajjForm');
        const submitBtn = document.getElementById('submitButton');
        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // Hide previous messages
        successMessage.style.display = 'none';
        errorMessage.style.display = 'none';

        // Prevent double submission
        if (submitBtn.disabled) {
            debugLog('ABBRUCH: Button bereits deaktiviert (Doppel-Submission verhindert)');
            return;
        }

        // Basic form validation
        if (!form.checkValidity()) {
            debugLog('ABBRUCH: Form-Validierung fehlgeschlagen');
            form.reportValidity();
            return;
        }

        debugLog('Form-Validierung erfolgreich');

        // Check required files
        const requiredFiles = ['passport-copy', 'passport-photo'];
        const passart = document.querySelector('input[name="passart"]:checked')?.value;

        if (passart === 'auslaendisch') {
            requiredFiles.push('aufenthaltstitel-image');
        }

        debugLog('ÃœberprÃ¼fe erforderliche Dateien: ' + requiredFiles.join(', '));
        debugLog('Passart: ' + passart);

        for (const fileId of requiredFiles) {
            const fileInput = document.getElementById(fileId);
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                debugLog(`FEHLER: Fehlende Datei: ${fileId}`);
                alert(`Bitte laden Sie eine Datei fÃ¼r ${fileId} hoch`);
                return;
            } else {
                const file = fileInput.files[0];
                debugLog(`âœ“ Datei OK: ${fileId} - ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
            }
        }

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'â³ Wird gesendet...';
        loading.style.display = 'block';
        debugLog('Submit-Button deaktiviert, Loading angezeigt');

        // Create FormData
        const formData = new FormData(form);
        debugLog('FormData erstellt');

        // Log form data contents
        debugLog('=== FORM DATA INHALT ===');
        for (let [key, value] of formData.entries()) {
            if (value instanceof File) {
                debugLog(`${key}: FILE - ${value.name} (${(value.size/1024).toFixed(1)}KB, ${value.type})`);
            } else {
                debugLog(`${key}: ${value}`);
            }
        }

        // Remove aufenthaltstitel if not needed
        if (passart !== 'auslaendisch') {
            formData.delete('aufenthaltstitel-image');
            debugLog('Aufenthaltstitel-Datei entfernt (nicht erforderlich)');
        }

        // Submit to server
        const submitUrl = '/.netlify/functions/submit-hajj-registration';
        debugLog('Sende an URL: ' + submitUrl);

        fetch(submitUrl, {
            method: 'POST',
            body: formData
        })
            .then(response => {
                debugLog(`Server-Antwort erhalten: Status ${response.status} (${response.statusText})`);

                if (!response.ok) {
                    throw new Error(`Server Error ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                debugLog('JSON-Antwort erhalten: ' + JSON.stringify(data, null, 2));
                loading.style.display = 'none';

                if (data.success) {
                    debugLog('ğŸ‰ ERFOLG! Registration ID: ' + data.id);
                    successMessage.innerHTML = `
                    âœ… <strong>Erfolgreich versendet!</strong><br><br>
                    Ihre Hajj-Registrierung wurde erfolgreich Ã¼bermittelt (ID: ${data.id}).<br>
                    Sie erhalten in KÃ¼rze eine BestÃ¤tigung per E-Mail.
                `;
                    successMessage.style.display = 'block';

                    // Reset form
                    form.reset();
                    document.querySelectorAll('.preview-container').forEach(preview => {
                        preview.style.display = 'none';
                    });
                    document.getElementById('aufenthaltstitelSection').classList.remove('show');

                    // Reset button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'ğŸ“¤ Hajj-Anmeldung absenden (DEBUG)';

                    // Scroll to success message
                    successMessage.scrollIntoView({ behavior: 'smooth' });

                } else {
                    throw new Error(data.error || 'Unbekannter Server-Fehler');
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                debugLog('âŒ FEHLER: ' + error.message);
                console.error('Submit Error:', error);

                let errorDetails = '';
                if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorDetails = 'Netzwerkfehler - Bitte Ã¼berprÃ¼fen Sie Ihre Internetverbindung.';
                } else if (error.message.includes('Server Error')) {
                    errorDetails = 'Server-Fehler - Bitte versuchen Sie es spÃ¤ter erneut.';
                } else {
                    errorDetails = error.message;
                }

                errorMessage.innerHTML = `
                âŒ <strong>Fehler beim Senden</strong><br><br>
                <strong>Fehlerdetails:</strong> ${errorDetails}<br><br>
                Bitte versuchen Sie es erneut oder kontaktieren Sie den Support.
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 10px; padding: 15px; margin-top: 15px; text-align: center;">
                    <strong>ğŸ“ Support kontaktieren:</strong><br>
                    Telefon: <a href="tel:+491234567890" style="color: #3498db; text-decoration: none; font-weight: bold;">+49 123 456 7890</a><br>
                    E-Mail: <a href="mailto:support@hajj-services.de" style="color: #3498db; text-decoration: none; font-weight: bold;">support@hajj-services.de</a>
                </div>
            `;
                errorMessage.style.display = 'block';

                // Re-enable button after error
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'ğŸ”„ Erneut versuchen (DEBUG)';

                // Scroll to error message
                errorMessage.scrollIntoView({ behavior: 'smooth' });
            });
    }

    // Phone number formatting
    document.addEventListener('input', function(e) {
        if (e.target && e.target.id === 'telefon') {
            let value = e.target.value.replace(/\D/g, '');
            if (value.startsWith('49')) {
                value = '+' + value;
            } else if (value.startsWith('0')) {
                value = '+49' + value.substring(1);
            }
            e.target.value = value;
            debugLog('Telefonnummer formatiert: ' + value);
        }
    });

    // Passport number formatting (uppercase)
    document.addEventListener('input', function(e) {
        if (e.target && e.target.id === 'passnummer') {
            e.target.value = e.target.value.toUpperCase();
        }
    });

    // Email validation
    document.addEventListener('blur', function(e) {
        if (e.target && e.target.id === 'email') {
            const email = e.target.value;
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailPattern.test(email)) {
                e.target.setCustomValidity('Bitte geben Sie eine gÃ¼ltige E-Mail Adresse ein');
                debugLog('E-Mail-Validierung fehlgeschlagen: ' + email);
            } else {
                e.target.setCustomValidity('');
                debugLog('E-Mail-Validierung erfolgreich: ' + email);
            }
        }
    }, true);

    // Age validation
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'geburtsdatum') {
            const birthDate = new Date(e.target.value);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }

            debugLog('Alter berechnet: ' + age + ' Jahre');

            if (age < 18) {
                alert('âš ï¸ Warnung: Sie mÃ¼ssen mindestens 18 Jahre alt sein.');
                debugLog('Altersvalidierung fehlgeschlagen: ' + age + ' Jahre');
            }
        }
    });

    // Passport validity check
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'passgueltigkeit') {
            const selectedDate = new Date(e.target.value);
            const sixMonthsFromNow = new Date();
            sixMonthsFromNow.setMonth(sixMonthsFromNow.getMonth() + 6);

            if (selectedDate < sixMonthsFromNow) {
                alert('âš ï¸ Warnung: Ihr Pass lÃ¤uft in weniger als 6 Monaten ab.');
                debugLog('Pass-GÃ¼ltigkeit Warnung: LÃ¤uft ab am ' + selectedDate.toLocaleDateString());
            } else {
                debugLog('Pass-GÃ¼ltigkeit OK: LÃ¤uft ab am ' + selectedDate.toLocaleDateString());
            }
        }
    });

    debugLog('Alle Event-Listener eingerichtet. Formular bereit.');

    // Test function (can be called from console)
    window.testSubmit = function() {
        debugLog('ğŸ§ª TEST-SUBMISSION gestartet');
        handleFormSubmission();
    };

    // Global error handler
    window.addEventListener('error', function(e) {
        debugLog('ğŸš¨ GLOBALER JAVASCRIPT-FEHLER: ' + e.message + ' in ' + e.filename + ':' + e.lineno);
    });

    debugLog('ğŸš€ JavaScript-Setup abgeschlossen!');
</script>
</body>
</html>