<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hajj Passport Registration Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .logo {
            max-width: 150px;
            max-height: 80px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(255,255,255,0.2);
        }

        .logo-upload {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .logo-upload input {
            display: none;
        }

        .logo-upload label {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .logo-upload label:hover {
            background: rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-container {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .bilingual-label {
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
        }

        .label-german {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
            margin-bottom: 2px;
        }

        .label-arabic {
            font-weight: 500;
            color: #5a6c7d;
            font-size: 0.9em;
            direction: rtl;
            text-align: right;
            font-family: 'Arial', 'Tahoma', sans-serif;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        select {
            cursor: pointer;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #3498db;
        }

        .radio-item label {
            cursor: pointer;
            font-weight: 500;
            color: #2c3e50;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed #3498db;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            min-height: 80px;
            text-align: center;
        }

        .file-upload-label:hover {
            border-color: #2980b9;
            background: #e3f2fd;
        }

        .file-upload-label.error {
            border-color: #e74c3c;
            background: #ffeaea;
        }

        .file-upload-label .upload-icon {
            font-size: 2em;
            margin-bottom: 10px;
            color: #3498db;
        }

        .file-upload-label .upload-text {
            color: #2c3e50;
            font-weight: 500;
        }

        .file-error {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .file-info {
            color: #27ae60;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .preview-container {
            margin-top: 15px;
            display: none;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .section-title-arabic {
            font-size: 1.1em;
            margin-top: 5px;
            color: #5a6c7d;
            direction: rtl;
            font-family: 'Arial', 'Tahoma', sans-serif;
        }

        .conditional-field {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
        }

        .conditional-field.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .submit-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 18px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(52, 152, 219, 0.4);
        }

        .submit-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .required {
            color: #e74c3c;
        }

        .info-text {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .form-row, .form-row-three {
                grid-template-columns: 1fr;
            }

            .container {
                margin: 10px;
            }

            .form-container {
                padding: 20px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .logo-upload {
                position: static;
                margin-bottom: 15px;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }

        .success-message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
            text-align: center;
        }

        .error-message {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .contact-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }

        .contact-info strong {
            color: #2c3e50;
        }

        .phone-link {
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
        }

        .phone-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">

        <div id="logoContainer">
            <img src="./logo.jpg" alt="Logo" class="logo" id="logoImage">
        </div>

        <h1>Hajj Anmeldung<br><small style="font-size: 0.6em; opacity: 0.9;">تسجيل الحج</small></h1>
        <p>Bitte füllen Sie alle Felder sorgfältig aus<br><small style="opacity: 0.8;">يرجى ملء جميع الحقول بعناية</small></p>
    </div>

    <div class="form-container">
        <div class="success-message" id="successMessage">
            ✅ <strong>Erfolgreich versendet!</strong><br>
            <small style="opacity: 0.8;">تم الإرسال بنجاح!</small><br><br>
            Ihre Hajj-Registrierung wurde erfolgreich übermittelt. Wir werden uns in Kürze melden.<br>
            <small style="opacity: 0.8;">تم إرسال تسجيل الحج الخاص بك بنجاح. ستتلقى تأكيداً قريباً.</small>
        </div>

        <div class="error-message" id="errorMessage">
            ❌ <strong>Fehler beim Senden</strong><br>
            <small style="opacity: 0.8;">خطأ في الإرسال</small><br><br>
            Es gab einen technischen Fehler beim Übermitteln Ihrer Daten.<br>
            <small style="opacity: 0.8;">حدث خطأ تقني في إرسال بياناتك.</small>
            <div class="contact-info">
                <strong>📞 Support kontaktieren:</strong><br>
                <small>اتصل بالدعم:</small><br>
                Telefon: <a href="tel:+491234567890" class="phone-link">+49 123 456 7890</a><br>
                E-Mail: <a href="mailto:support@hajj-services.de" class="phone-link">support@hajj-services.de</a><br>
                WhatsApp: <a href="https://wa.me/491234567890" class="phone-link" target="_blank">📱 WhatsApp</a>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Daten werden übermittelt...<br><small>جاري إرسال البيانات...</small></p>
        </div>

        <form id="hajjForm" method="POST" action="#">
            <!-- Personal Information Section -->
            <div class="section-title">
                <div>Persönliche Informationen</div>
                <div class="section-title-arabic">المعلومات الشخصية</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Vorname <span class="required">*</span></div>
                        <div class="label-arabic">الاسم الأول</div>
                    </div>
                    <input type="text" id="vorname" name="vorname" placeholder="Vorname / الاسم الأول" required>
                </div>
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Nachname <span class="required">*</span></div>
                        <div class="label-arabic">اسم العائلة</div>
                    </div>
                    <input type="text" id="nachname" name="nachname" placeholder="Nachname / اسم العائلة" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">E-Mail Adresse <span class="required">*</span></div>
                        <div class="label-arabic">عنوان البريد الإلكتروني</div>
                    </div>
                    <input type="email" id="email" name="email" placeholder="email@example.com" required>
                </div>
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Telefonnummer (WhatsApp) <span class="required">*</span></div>
                        <div class="label-arabic">رقم الهاتف (واتساب)</div>
                    </div>
                    <input type="tel" id="telefon" name="telefon" placeholder="+49 123 456789" required>
                    <div class="info-text">Bitte WhatsApp-fähige Nummer angeben / يرجى إدخال رقم واتساب</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Geburtsdatum <span class="required">*</span></div>
                        <div class="label-arabic">تاريخ الميلاد</div>
                    </div>
                    <input type="date" id="geburtsdatum" name="geburtsdatum" required>
                </div>
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Nationalität <span class="required">*</span></div>
                        <div class="label-arabic">الجنسية</div>
                    </div>
                    <select id="nationalitaet" name="nationalitaet" required>
                        <option value="">Nationalität wählen / اختر الجنسية</option>
                        <optgroup label="Europa / أوروبا">
                            <option value="deutsch">Deutsch / ألماني</option>
                            <option value="oesterreichisch">Österreichisch / نمساوي</option>
                            <option value="schweiz">Schweizer / سويسري</option>
                            <option value="niederlaendisch">Niederländisch / هولندي</option>
                            <option value="belgisch">Belgisch / بلجيكي</option>
                            <option value="franzoesisch">Französisch / فرنسي</option>
                            <option value="italienisch">Italienisch / إيطالي</option>
                            <option value="spanisch">Spanisch / إسباني</option>
                            <option value="britisch">Britisch / بريطاني</option>
                            <option value="tuerkisch">Türkisch / تركي</option>
                            <option value="syrisch">Syrisch / سوري</option>
                            <option value="irakisch">Irakisch / عراقي</option>
                            <option value="afghanisch">Afghanisch / أفغاني</option>
                            <option value="marokkanisch">Marokkanisch / مغربي</option>
                            <option value="tunesisch">Tunesisch / تونسي</option>
                            <option value="aegyptisch">Ägyptisch / مصري</option>
                            <option value="libanesisch">Libanesisch / لبناني</option>
                            <option value="jordanisch">Jordanisch / أردني</option>
                            <option value="palaestinensisch">Palästinensisch / فلسطيني</option>
                            <option value="pakistanisch">Pakistanisch / باكستاني</option>
                            <option value="indisch">Indisch / هندي</option>
                            <option value="bangladeschisch">Bangladeschisch / بنغلاديشي</option>
                            <option value="sonstige">Sonstige / أخرى</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <!-- Passport Information Section -->
            <div class="section-title">
                <div>Reisepass Informationen</div>
                <div class="section-title-arabic">معلومات جواز السفر</div>
            </div>

            <div class="form-group">
                <div class="bilingual-label">
                    <div class="label-german">Art des Reisepasses <span class="required">*</span></div>
                    <div class="label-arabic">نوع جواز السفر</div>
                </div>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="pass_europaeisch" name="passart" value="europaeisch" required>
                        <label for="pass_europaeisch">Europäischer Pass<br><small>الجواز الأوروبي</small></label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="pass_blau" name="passart" value="blau" required>
                        <label for="pass_blau">Blauer Reiseausweis<br><small>وثيقة السفر الزرقاء</small></label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="pass_auslaendisch" name="passart" value="auslaendisch" required>
                        <label for="pass_auslaendisch">Ausländischer Pass mit Aufenthaltstitel<br><small>جواز سفر أجنبي مع إقامة</small></label>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Passnummer <span class="required">*</span></div>
                        <div class="label-arabic">رقم جواز السفر</div>
                    </div>
                    <input type="text" id="passnummer" name="passnummer" placeholder="Passnummer / رقم جواز السفر" required>
                </div>
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Pass Gültigkeit <span class="required">*</span></div>
                        <div class="label-arabic">صلاحية جواز السفر</div>
                    </div>
                    <input type="date" id="passgueltigkeit" name="passgueltigkeit" required>
                    <div class="info-text">Muss mindestens 6 Monate gültig sein / يجب أن يكون صالحاً لمدة 6 أشهر على الأقل</div>
                </div>
            </div>

            <!-- Conditional Aufenthaltstitel Field -->
            <div id="aufenthaltstitelSection" class="conditional-field">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Aufenthaltstitel hochladen <span class="required">*</span></div>
                        <div class="label-arabic">تحميل تصريح الإقامة</div>
                    </div>
                    <div class="file-upload">
                        <input type="file" id="aufenthaltstitel-image" name="aufenthaltstitel-image" accept="image/*,application/pdf">
                        <label for="aufenthaltstitel-image" class="file-upload-label">
                            <div>
                                <div class="upload-icon">📄</div>
                                <div class="upload-text">Aufenthaltstitel hochladen<br><small style="color: #7f8c8d;">تحميل تصريح الإقامة</small></div>
                                <small>JPG, PNG, PDF • Max. 10MB<br>الوجهين مطلوبان • حد أقصى 10 ميجابايت</small>
                            </div>
                        </label>
                    </div>
                    <div class="file-error" id="aufenthaltstitel-error"></div>
                    <div class="file-info" id="aufenthaltstitel-info"></div>
                    <div class="preview-container" id="aufenthaltstitel-preview">
                        <img class="image-preview" id="aufenthaltstitel-img">
                        <div class="pdf-preview" id="aufenthaltstitel-pdf" style="display: none;">
                            <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px; padding: 20px; text-align: center;">
                                <div style="font-size: 3em; margin-bottom: 10px;">📄</div>
                                <div style="font-weight: 600; color: #2c3e50;">PDF Dokument</div>
                                <div style="color: #7f8c8d; margin-top: 5px;" id="aufenthaltstitel-pdf-name"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document Upload Section -->
            <div class="section-title">
                <div>Dokumente hochladen</div>
                <div class="section-title-arabic">تحميل الوثائق</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Reisepass Kopie <span class="required">*</span></div>
                        <div class="label-arabic">نسخة من جواز السفر</div>
                    </div>
                    <div class="file-upload">
                        <input type="file" id="passport-copy" name="passport-copy" accept="image/*,application/pdf" required>
                        <label for="passport-copy" class="file-upload-label">
                            <div>
                                <div class="upload-icon">📋</div>
                                <div class="upload-text">Reisepass Kopie<br><small style="color: #7f8c8d;">نسخة جواز السفر</small></div>
                                <small>JPG, PNG, PDF • Max. 10MB<br>جميع الصفحات ذات الصلة • حد أقصى 10 ميجابايت</small>
                            </div>
                        </label>
                    </div>
                    <div class="file-error" id="passport-copy-error"></div>
                    <div class="file-info" id="passport-copy-info"></div>
                    <div class="preview-container" id="passport-copy-preview">
                        <img class="image-preview" id="passport-copy-img">
                        <div class="pdf-preview" id="passport-copy-pdf" style="display: none;">
                            <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px; padding: 20px; text-align: center;">
                                <div style="font-size: 3em; margin-bottom: 10px;">📄</div>
                                <div style="font-weight: 600; color: #2c3e50;">PDF Dokument</div>
                                <div style="color: #7f8c8d; margin-top: 5px;" id="passport-copy-pdf-name"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="bilingual-label">
                        <div class="label-german">Biometrisches Passbild <span class="required">*</span></div>
                        <div class="label-arabic">صورة جواز سفر بيومترية</div>
                    </div>
                    <div class="file-upload">
                        <input type="file" id="passport-photo" name="passport-photo" accept="image/*,application/pdf" required>
                        <label for="passport-photo" class="file-upload-label">
                            <div>
                                <div class="upload-icon">📷</div>
                                <div class="upload-text">Biometrisches Passbild<br><small style="color: #7f8c8d;">صورة بيومترية</small></div>
                                <small>JPG, PNG, PDF • Max. 10MB<br>خلفية بيضاء، 35x45 ملم • حد أقصى 10 ميجابايت</small>
                            </div>
                        </label>
                    </div>
                    <div class="file-error" id="passport-photo-error"></div>
                    <div class="file-info" id="passport-photo-info"></div>
                    <div class="preview-container" id="passport-photo-preview">
                        <img class="image-preview" id="passport-photo-img">
                        <div class="pdf-preview" id="passport-photo-pdf" style="display: none;">
                            <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px; padding: 20px; text-align: center;">
                                <div style="font-size: 3em; margin-bottom: 10px;">📄</div>
                                <div style="font-weight: 600; color: #2c3e50;">PDF Dokument</div>
                                <div style="color: #7f8c8d; margin-top: 5px;" id="passport-photo-pdf-name"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nusuk Registration Section -->
            <div class="section-title">
                <div>📱 Nusuk Registration</div>
                <div class="section-title-arabic">تسجيل نسك</div>
            </div>

            <div class="form-group">
                <div class="bilingual-label">
                    <div class="label-german">Haben Sie sich bereits auf Nusuk registriert? <span class="required">*</span></div>
                    <div class="label-arabic">هل قمت بالتسجيل على نسك بالفعل؟</div>
                </div>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" id="nusuk_ja" name="nusuk_registriert" value="ja" required>
                        <label for="nusuk_ja">Ja / نعم</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="nusuk_nein" name="nusuk_registriert" value="nein" required>
                        <label for="nusuk_nein">Nein / لا</label>
                    </div>
                </div>
                <div class="info-text">
                    Nusuk ist die offizielle Saudi-Arabische Plattform für Hajj und Umrah Registrierungen<br>
                    <small>نسك هو المنصة الرسمية السعودية لتسجيلات الحج والعمرة</small>
                </div>
            </div>

            <button type="button" class="submit-btn" id="submitButton">
                 Hajj-Anmeldung absenden<br><small style="font-size: 0.8em; opacity: 0.9;">إرسال تسجيل الحج</small>
            </button>
        </form>
    </div>
</div>

<script>
    // Early form submission prevention
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('hajjForm');

        // Add multiple event listeners to catch all submission attempts
        ['submit', 'formdata'].forEach(eventType => {
            form.addEventListener(eventType, function(e) {
                console.log('Form event intercepted:', eventType);
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }, true); // Use capture phase
        });

        // Override form submission method
        form.submit = function() {
            console.log('Direct form.submit() call blocked');
            return false;
        };
    });

    // Logo upload functionality
    document.getElementById('logoUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const logoContainer = document.getElementById('logoContainer');
                logoContainer.innerHTML = `<img src="${e.target.result}" alt="Company Logo" class="logo" id="logoImage">`;
                localStorage.setItem('companyLogo', e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });

    // Load saved logo
    document.addEventListener('DOMContentLoaded', function() {
        const savedLogo = localStorage.getItem('companyLogo');
        if (savedLogo) {
            const logoContainer = document.getElementById('logoContainer');
            logoContainer.innerHTML = `<img src="${savedLogo}" alt="Company Logo" class="logo" id="logoImage">`;
        }
    });

    // Conditional Aufenthaltstitel field
    document.querySelectorAll('input[name="passart"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const aufenthaltstitelSection = document.getElementById('aufenthaltstitelSection');
            const aufenthaltstitelInput = document.getElementById('aufenthaltstitel-image');

            if (this.value === 'auslaendisch') {
                aufenthaltstitelSection.classList.add('show');
                aufenthaltstitelInput.required = true;
            } else {
                aufenthaltstitelSection.classList.remove('show');
                aufenthaltstitelInput.required = false;
            }
        });
    });

    // File type and size validation function
    function validateFile(file, inputElement, errorElementId, infoElementId) {
        const maxSize = 10 * 1024 * 1024; // 10MB in bytes
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
        const errorElement = document.getElementById(errorElementId);
        const infoElement = document.getElementById(infoElementId);
        const label = inputElement.parentElement.querySelector('.file-upload-label');

        // Reset previous states
        errorElement.style.display = 'none';
        infoElement.style.display = 'none';
        label.classList.remove('error');

        // Check file type
        if (!allowedTypes.includes(file.type)) {
            errorElement.innerHTML = `
                ❌ Ungültiger Dateityp: ${file.type}<br>
                Erlaubt: JPG, PNG, GIF, WebP, PDF<br>
                <small>نوع ملف غير صحيح. المسموح: JPG, PNG, GIF, WebP, PDF</small>
            `;
            errorElement.style.display = 'block';
            label.classList.add('error');
            inputElement.value = '';
            return false;
        }

        // Check file size
        if (file.size > maxSize) {
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            errorElement.innerHTML = `
                ❌ Datei zu groß: ${sizeMB}MB (Max: 10MB)<br>
                <small>الملف كبير جداً: ${sizeMB} ميجابايت (الحد الأقصى: 10 ميجابايت)</small>
            `;
            errorElement.style.display = 'block';
            label.classList.add('error');
            inputElement.value = '';
            return false;
        } else {
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            const fileTypeText = file.type === 'application/pdf' ? 'PDF' : 'Bild';
            const fileTypeArabic = file.type === 'application/pdf' ? 'PDF' : 'صورة';
            infoElement.innerHTML = `
                ✅ ${fileTypeText} akzeptiert: ${file.name} (${sizeMB}MB)<br>
                <small>تم قبول ${fileTypeArabic}: ${file.name} (${sizeMB} ميجابايت)</small>
            `;
            infoElement.style.display = 'block';
            return true;
        }
    }

    // Enhanced preview functionality with PDF support
    function setupFilePreview(inputId, previewId, imgId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const img = document.getElementById(imgId);
        const pdfPreview = document.getElementById(inputId + '-pdf');
        const pdfName = document.getElementById(inputId + '-pdf-name');
        const errorElementId = inputId + '-error';
        const infoElementId = inputId + '-info';

        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validate file first
                if (!validateFile(file, input, errorElementId, infoElementId)) {
                    preview.style.display = 'none';
                    return;
                }

                // Show preview based on file type
                if (file.type === 'application/pdf') {
                    // PDF Preview
                    img.style.display = 'none';
                    if (pdfPreview && pdfName) {
                        pdfName.textContent = file.name;
                        pdfPreview.style.display = 'block';
                    }
                    preview.style.display = 'block';
                } else {
                    // Image Preview
                    if (pdfPreview) {
                        pdfPreview.style.display = 'none';
                    }
                    img.style.display = 'block';

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }
        });
    }

    // Setup previews for all file inputs with PDF support
    setupFilePreview('passport-copy', 'passport-copy-preview', 'passport-copy-img');
    setupFilePreview('passport-photo', 'passport-photo-preview', 'passport-photo-img');
    setupFilePreview('aufenthaltstitel-image', 'aufenthaltstitel-preview', 'aufenthaltstitel-img');

    // Button click handler (safer than form submit)
    document.getElementById('submitButton').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Call the form submission logic
        handleFormSubmission();
    });

    // Separate function for form submission logic
    function handleFormSubmission() {
        const form = document.getElementById('hajjForm');
        const submitBtn = document.getElementById('submitButton');
        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // Prevent double submission
        if (submitBtn.disabled) {
            return;
        }

        // Basic form validation
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // Final file validation before submission
        const fileInputs = ['passport-copy', 'passport-photo', 'aufenthaltstitel-image'];
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
        let hasInvalidFiles = false;

        fileInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input.files.length > 0) {
                const file = input.files[0];

                // Check file type
                if (!allowedTypes.includes(file.type)) {
                    hasInvalidFiles = true;
                    alert(`❌ Ungültiger Dateityp: ${file.name}\nErlaubt: JPG, PNG, GIF, WebP, PDF\n\nنوع ملف غير صحيح: ${file.name}\nالمسموح: JPG, PNG, GIF, WebP, PDF`);
                    return;
                }

                // Check file size
                if (file.size > 10 * 1024 * 1024) { // 10MB check
                    hasInvalidFiles = true;
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    alert(`❌ Fehler: ${file.name} ist ${sizeMB}MB groß (Max: 10MB)\n\nخطأ: ${file.name} حجمه ${sizeMB} ميجابايت (الحد الأقصى: 10 ميجابايت)`);
                }
            }
        });

        if (hasInvalidFiles) {
            return; // Stop submission
        }

        // Disable submit button immediately
        submitBtn.disabled = true;
        submitBtn.innerHTML = '⏳ Wird gesendet...<br><small style="font-size: 0.8em; opacity: 0.9;">جاري الإرسال...</small>';

        // Hide previous messages
        successMessage.style.display = 'none';
        errorMessage.style.display = 'none';
        loading.style.display = 'block';

        // Create FormData object
        const formData = new FormData(form);

        // Remove empty aufenthaltstitel file if passart is not 'auslaendisch'
        const passart = formData.get('passart');
        if (passart !== 'auslaendisch') {
            formData.delete('aufenthaltstitel-image');
            console.log('Removed aufenthaltstitel-image from FormData (not required for passart:', passart, ')');
        }

        // Submit to Netlify Function
        fetch('/.netlify/functions/submit-hajj-registration', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server Error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';

                if (data.success) {
                    // SUCCESS
                    successMessage.innerHTML = `
                    ✅ <strong>Erfolgreich versendet!</strong><br>
                    <small style="opacity: 0.8;">تم الإرسال بنجاح!</small><br><br>
                    Ihre Hajj-Registrierung wurde erfolgreich übermittelt (ID: ${data.id}).<br>
                    Sie erhalten in Kürze eine Bestätigung per E-Mail und WhatsApp.<br>
                    <small style="opacity: 0.8;">تم إرسال تسجيل الحج الخاص بك بنجاح. ستتلقى تأكيداً عبر البريد الإلكتروني وواتساب.</small>
                `;
                    successMessage.style.display = 'block';

                    // Reset form and previews
                    form.reset();
                    document.getElementById('passport-copy-preview').style.display = 'none';
                    document.getElementById('passport-photo-preview').style.display = 'none';
                    document.getElementById('aufenthaltstitel-preview').style.display = 'none';
                    document.getElementById('aufenthaltstitelSection').classList.remove('show');

                    // Reset button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '📤 Hajj-Registrierung absenden<br><small style="font-size: 0.8em; opacity: 0.9;">إرسال تسجيل الحج</small>';

                } else {
                    throw new Error(data.error || 'Unbekannter Server-Fehler');
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                console.error('Submit Error:', error);

                // ERROR - Show error message with contact info
                let errorDetails = '';
                if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    errorDetails = 'Netzwerkfehler - Bitte überprüfen Sie Ihre Internetverbindung.';
                } else if (error.message.includes('Server Error')) {
                    errorDetails = 'Server-Fehler - Bitte versuchen Sie es später erneut.';
                } else {
                    errorDetails = error.message;
                }

                errorMessage.innerHTML = `
                ❌ <strong>Fehler beim Senden</strong><br>
                <small style="opacity: 0.8;">خطأ في الإرسال</small><br><br>
                <strong>Fehlerdetails:</strong> ${errorDetails}<br><br>
                Bitte versuchen Sie es erneut oder kontaktieren Sie uns für Hilfe.<br>
                <small style="opacity: 0.8;">يرجى المحاولة مرة أخرى أو الاتصال بنا للحصول على المساعدة.</small>
                <div class="contact-info">
                    <strong>📞 Support kontaktieren:</strong><br>
                    <small>اتصل بالدعم:</small><br>
                    Telefon: <a href="tel:+491234567890" class="phone-link">+49 123 456 7890</a><br>
                    E-Mail: <a href="mailto:support@hajj-services.de" class="phone-link">support@hajj-services.de</a><br>
                    WhatsApp: <a href="https://wa.me/491234567890?text=Hilfe%20bei%20Hajj%20Registration" class="phone-link" target="_blank">📱 WhatsApp Support</a>
                </div>
            `;
                errorMessage.style.display = 'block';

                // Re-enable button after error
                submitBtn.disabled = false;
                submitBtn.innerHTML = '🔄 Erneut versuchen<br><small style="font-size: 0.8em; opacity: 0.9;">حاول مرة أخرى</small>';
            });
    }

    // Form submission event (backup - should not trigger)
    document.getElementById('hajjForm').addEventListener('submit', function(e) {
        console.log('Form submit event triggered - this should not happen');
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        // Call the same handler as backup
        handleFormSubmission();

        return false;
    });

    // Phone number formatting
    document.getElementById('telefon').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.startsWith('49')) {
            value = '+' + value;
        } else if (value.startsWith('0')) {
            value = '+49' + value.substring(1);
        }
        e.target.value = value;
    });

    // Passport number formatting (uppercase)
    document.getElementById('passnummer').addEventListener('input', function(e) {
        e.target.value = e.target.value.toUpperCase();
    });

    // Email validation
    document.getElementById('email').addEventListener('blur', function(e) {
        const email = e.target.value;
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email && !emailPattern.test(email)) {
            e.target.setCustomValidity('Bitte geben Sie eine gültige E-Mail Adresse ein');
        } else {
            e.target.setCustomValidity('');
        }
    });

    // Passport validity check (must be at least 6 months in future)
    document.getElementById('passgueltigkeit').addEventListener('change', function(e) {
        const selectedDate = new Date(e.target.value);
        const sixMonthsFromNow = new Date();
        sixMonthsFromNow.setMonth(sixMonthsFromNow.getMonth() + 6);

        if (selectedDate < sixMonthsFromNow) {
            alert('⚠️ Warnung: Ihr Pass läuft in weniger als 6 Monaten ab. Dies könnte zu Problemen führen.\n\nتحذير: ينتهي جوازك خلال أقل من 6 أشهر. قد يؤدي هذا إلى مشاكل.');
        }
    });

    // Age validation (must be at least 18 years old)
    document.getElementById('geburtsdatum').addEventListener('change', function(e) {
        const birthDate = new Date(e.target.value);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();

        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
    });
</script>
</body>
</html>